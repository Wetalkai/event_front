<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detección de Expresiones Faciales</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css">
    <script src="tipoPruebas.js"></script>
    <link href="styles.css" rel="stylesheet">

</head>

<body class="bg-dark text-white">
    
    <div class="container">
        <h1 id="titleTest" class="text-center my-4">Título de prueba</h1>

        <!-- Espacio reservado para la imagen de la cámara -->
        <div class="d-flex justify-content-center">
            <div class="camera-container">
                <video id="webcam" autoplay playsinline></video>
            </div>
        </div>

        <p id="descriptionTest" class="text-center my-4"></p>

        <!-- Botones de acción -->
        <div class="d-flex justify-content-around my-4">
            <button id="capture" class="btn btn-primary">
                <i class="fa fa-camera"></i>
            </button>


            <button id="loadModel" class="btn btn-success" style="display: none;">Progreso</button>
        </div>
    </div>

    <!-- Modal para controles de la foto capturada -->
    <div id="photoControls" class="modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <button id="closeBtnPhoto" type="button" class="btn-close" data-bs-dismiss="modal"
                    aria-label="Close"></button>
                <div class="modal-body">
                    <img id="capturedPhoto">
                </div>
                <div class="modal-footer">
                    <button id="send" class="btn btn-primary">Enviar</button>
                </div>
            </div>
        </div>
    </div>

    <canvas id="canvasPhoto" style="display:none;"></canvas>

    <script>

        
        const videoElement = document.getElementById('webcam');
        var button = document.getElementById('capture');
        button.disabled = true;
        button.style.opacity = 0.1;

        function onResults(results) {
            let bocasAbiertas = 0; // Contador para las bocas abiertas

            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 1) { // Asegurarse de que hay al menos 2 caras detectadas
                for (const landmarks of results.multiFaceLandmarks) {
                    // Índices de landmarks para el labio superior e inferior
                    const upperLipTop = landmarks[13];
                    const lowerLipBottom = landmarks[14];

                    // Calcular la distancia vertical entre los landmarks del labio superior e inferior
                    const verticalDistance = lowerLipBottom.y - upperLipTop.y;

                    // Determinar si la boca está abierta
                    if (verticalDistance > 0.03) { // Este valor es un umbral y puede necesitar ajustes
                        console.log('Boca abierta');
                        bocasAbiertas += 1; // Incrementar el contador de bocas abiertas
                    }
                }
                console.log(bocasAbiertas)

                // Verificar si hay dos bocas abiertas
                if (bocasAbiertas >= 2) {
                    console.log('Dos bocas abiertas detectadas');
                    button.disabled = false;
                    button.style.opacity = 1;
                } else {
                    button.disabled = true;
                    button.style.opacity = 0.1;
                }
            } else {
                console.log("sólo una cara")
                // Si no hay suficientes caras, deshabilitar el botón
                button.disabled = true;
                button.style.opacity = 0.1;
            }
        }


        const faceMesh = new FaceMesh({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`,
        });

        faceMesh.setOptions({
            maxNumFaces: 2,
            refineLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5,
            outputFaceBlendshapes: true
        });

        faceMesh.onResults(onResults);

        new Camera(videoElement, {
            onFrame: async () => {
                await faceMesh.send({ image: videoElement });
            },
            width: 640,
            height: 480
        }).start();

    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="script.js"></script>
</body>

</html>